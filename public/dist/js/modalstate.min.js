/* License: MIT - https://github.com/angular-ui/bootstrap/blob/master/LICENSE */
angular.module("modalstate",["ui.router","ui.bootstrap"]).provider("modalState",["$stateProvider",function(t){function e(t,o){if(a){var n=l;l=t.getTop(),void 0===l||l===n?(i[void 0===l?"resolve":"reject"](c),i=null,c=null,l=null,a=!1):(t.dismissAll(c),o(function(){e(t,o)}))}}function o(t,o,l){return{state:this.state,getDepth:function(){return n.length},isTop:function(){var t=l.getTop();return t&&n.length&&t.value.modalScope===n[n.length-1].scope},setParentScope:function(t){r=t},dismissAll:function(n){return a||(a=!0,c=n,i=t.defer()),e(l,o),i?i.promise:t.when(void 0)}}}var n=[],r=null,a=!1,l=null,c=null,i=null;e.$inject=["$uibModalStack","$timeout"],this.$get=o,o.$inject=["$q","$timeout","$uibModalStack"],this.state=function(e,o){function a(t,a,l,i,u){n.push(c);var d={};"function"==typeof c.onEnter&&"[object Function]"==d.toString.call(c.onEnter)&&l.invoke(c.onEnter),c.broadcast=!0,c.result=null,c.closed=!1,c.startListener=t.$on("$stateChangeStart",function(t,o,n,r,a){r.name!==e||c.childPattern.test(o.name)||(c.broadcast?(c.result=void 0,c.closed=!1,c.scope&&c.scope.$broadcast("modal.closing",c.result,c.closed).defaultPrevented&&t.preventDefault()):c.broadcast=!0)});var f=Object.keys(o),p=Object.keys(s),$=["returnState","onModal","onEnter","onExit","scope"];p.forEach(function(t){delete f[t]}),$.forEach(function(t){delete f[t]});var m={};f.forEach(function(t){m[t]=o[t]}),m.scope=o.scope||r||t,r=null,c.modal=a.open(m),c.modal.opened.then(function(){var t;for(t=m.scope.$$childHead;t&&t.$close!==c.modal.close;t=t.$$nextSibling);if(!t)throw new Error("modalState: failed to identify controller scope under modal scope "+m.scope.$id);c.scope=t,t.$on("modal.closing",function(t,o,n){if(i.current.name===e){var r=t.defaultPrevented;t.preventDefault(),t.preventDefault=function(){r=!0},u(function(){r||(c.broadcast=!1,c.result=o,c.closed=n,i.go(c.returnState))})}})}),d={},"function"==typeof c.onModal&&"[object Function]"==d.toString.call(c.onModal)&&c.onModal(c.modal)}function l(t){c.startListener();var e=c.scope.$broadcast;c.scope.$broadcast=function(t,o){return"modal.closing"===t?{defaultPrevented:!1}:e.apply(this,arguments)},c.modal[c.closed?"close":"dismiss"](c.result),c.scope.$broadcast=e,delete c.startListener,delete c.scope,delete c.modal,delete c.result,getType={},"function"==typeof c.onExit&&"[object Function]"==getType.toString.call(c.onExit)&&t.invoke(c.onExit),n.pop()}var c={childPattern:new RegExp("^"+e.replace(/\./g,"\\.")+"\\."),returnState:o.returnState||"^",onModal:o.onModal||null,onEnter:o.onEnter||null,onExit:o.onExit||null},i=["url","params","abstract","reloadOnSearch","data"],s={};return i.forEach(function(t){s[t]=o[t]}),s.onEnter=a,a.$inject=["$rootScope","$uibModal","$injector","$state","$timeout"],s.onExit=l,l.$inject=["$injector"],t.state(e,s),this}}]).directive("modalScope",["modalState",function(t){return{restrict:"A",link:function(e,o,n){o.bind("click",function(){t.setParentScope(e)})}}}]);