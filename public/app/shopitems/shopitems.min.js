angular.module('app.shopitems',['ui.router','modalstate']).factory('Shopitems',['$resource','BASE_URI',function(t,e){return t(e+'api/shopitems/:id',null,{update:{method:'PUT'}});}]).factory('Frequentshopitems',['$resource','BASE_URI',function(t,e){return t(e+'api/frequentshopitems/');}]).factory('ShopitemService',['$rootScope','$timeout','$q','UserService','Shopitems',function(t,e,o,n,a){let s,r={shopitems:[],alerts:[],autoupdate:!0,pauseAutoupdate:0},u=function(t,e){let i;for(i=0;i<t.length;i++)if(angular.equals(t[i],e))return i;return!1;},p=function(){const e=o.defer();return a.query(function(o){const a=[],s=[],p=n.getCurrentLoginUser();for(i=0;i<o.length;i++){if(o[i].ingredient)var d=p.settings.categoryOrder.indexOf(o[i].ingredient.category)>=0?p.settings.categoryOrder.indexOf(o[i].ingredient.category):99999;else var d=99999;if(o[i].ingredient&&o[i].unit&&o[i].amount){o[i].ingredient.name_translated=o[i].ingredient.name[p.settings.preferredLanguage],o[i].unit.name_translated=o[i].unit.name[p.settings.preferredLanguage];const l={ingredient:o[i].ingredient,unit:o[i].unit,order:d,completed:o[i].completed,details:[],amount:0},c=u(s,l);c===!1?(s.push({ingredient:o[i].ingredient,unit:o[i].unit,order:d,completed:o[i].completed,details:[],amount:0}),l.details.push(o[i]),l.amount=o[i].amount,a.push(l)):(a[c].details.push(o[i]),a[c].amount=o[i].amount+a[c].amount);}}e.resolve(a),r.shopitems=a,t.$broadcast('shopitemsUpdated');}),e.promise;},d=function(t){const e=new Date;e.setDate(e.getDate()+14),e.setHours(0,0,0,0);const i=new a({ingredient:t.ingredient,unit:t.unit,amount:t.amount,completed:!1,expire_date:e});i.$save(),r.shopitems.push({ingredient:t.ingredient,unit:t.unit,completed:t.completed,details:[t],amount:t.amount});},l=function(i){if(r.pauseAutoupdate=r.pauseAutoupdate+1,i){const o=u(r.shopitems,i);if(o===!1)r.alerts.push({type:'danger',msg:'Match not found in existing shopping list, please inform the developer.'});else for(let n=i.details.length-1;n>=0;n--)a.remove({id:i.details[n]._id},null,function(t){for(var e,i=0;i<r.shopitems[o].details.length;i++)r.shopitems[o].details[i]._id==t._id&&(e=i);r.shopitems[o].details.splice(e,1),0===r.shopitems[o].details.length&&r.shopitems.splice(o,1);},function(t){r.alerts.push({type:'danger',msg:'Network connection error'});});}else a.remove({},null,function(e){r.shopitems=[],t.$broadcast('shopitemsUpdated');},function(t){r.alerts.push({type:'danger',msg:'Network connection error'});});e(function(){r.pauseAutoupdate=r.pauseAutoupdate-1;},5e3);},c=function(t){r.pauseAutoupdate=r.pauseAutoupdate+1;const i=u(r.shopitems,t);if(i===!1)r.alerts.push({type:'danger',msg:'Match not found in existing shopping list, please inform the developer.'});else{t.completed=!t.completed;for(let o=t.details.length-1;o>=0;o--)a.update({id:t.details[o]._id},{completed:t.completed},function(e){for(var o,n=0;n<r.shopitems[i].details.length;n++)r.shopitems[i].details[n]._id==e._id&&(o=n);r.shopitems[i].details[o].completed=t.completed;},function(t){r.alerts.push({type:'danger',msg:'Network connection error'});});r.shopitems[i].completed=t.completed;}e(function(){r.pauseAutoupdate=r.pauseAutoupdate-1;},5e3);},m=function(){r.autoupdate===!0&&r.pauseAutoupdate<=0?(p(),this.timer=e(function(){m();},5e3)):r.autoupdate===!1?e.cancel(s):this.timer=e(function(){m();},5e3);},h=function(){r.autoupdate!==!1&&this.timer||(r.autoupdate=!0,t.$broadcast('autoupdateValueChanged'),m());},f=function(){r.autoupdate=!1,t.$broadcast('autoupdateValueChanged'),e.cancel(s);};return{data:r,retrieveShopitems:p,addShopitem:d,remove:l,complete:c,startAutoupdate:h,stopAutoupdate:f};}]).controller('ShopitemsController',['$scope','$uibModal','ShopitemService','Shopitems','frequentshopitems','TAIngredients','units','shopitems',function(t,e,o,n,a,s,r,u){for(t.units=r,t.frequentshopitems=a,t.shopitems=o.data.shopitems,t.autoupdate=o.data.autoupdate,t.alerts=o.data.alerts,t.$on('shopitemsUpdated',function(){t.shopitems=o.data.shopitems;}),t.$on('autoupdateValueChanged',function(){t.autoupdate=o.data.autoupdate;}),t.status=[],i=0;i<t.shopitems.length;i++)t.status[t.shopitems[i].ingredient.category]=!0;t.addShopitem=function(t){o.addShopitem(t);},t.remove=function(t){o.remove(t);},t.complete=function(t){o.complete(t);},t.startAutoupdate=function(){o.startAutoupdate();},t.stopAutoupdate=function(){o.stopAutoupdate();},t.autoupdate===!0&&t.startAutoupdate(),t.$on('$destroy',function(e){t.stopAutoupdate();}),t.GetIngredients=function(t){return s.search({search:t,language:'de'}).$promise.then(function(t){return t;});},t.shopitemDetails=function(i){const n=e.open({animation:!0,templateUrl:'partials/shopitems.modal.details.tpl.html',controller:'ModalShopitemDetailsController',size:'lg',resolve:{item:function(){return i;},units:function(){return t.units;}}});n.result.then(function(){o.retrieveShopitems();});},t.closeAlert=function(e){t.alerts.splice(e,1);};}]).controller('ShopitemsActionController',['$scope','$uibModal','ShopitemService','units',function(t,e,i,o){t.units=o,t.autoupdate=i.data.autoupdate,t.alerts=i.data.alerts,t.$on('autoupdateValueChanged',function(){t.autoupdate=i.data.autoupdate;}),t.addShopitem=function(t){i.addShopitem(t);},t.remove=function(t){i.remove(t);},t.startAutoupdate=function(){i.startAutoupdate();},t.stopAutoupdate=function(){i.stopAutoupdate();};}]).controller('ShopitemsActionSidebarController',['$scope','$uibModal','ShopitemService','units','$uibModalInstance','isCordova',function(t,e,i,o,n,a){t.isCordova=a,t.units=o,t.autoupdate=i.data.autoupdate,t.alerts=i.data.alerts,t.$on('autoupdateValueChanged',function(){t.autoupdate=i.data.autoupdate;}),t.printingAvailable=cordova.plugins.printer.isAvailable(function(t){return t;}),t.printInApp=function(){const t=document.getElementById('section-to-print');cordova.plugins.printer.print(t,'Shopitems.html',function(){alert('printing finished or canceled');});},t.addShopitem=function(t){i.addShopitem(t);},t.remove=function(t){i.remove(t);},t.startAutoupdate=function(){i.startAutoupdate();},t.stopAutoupdate=function(){i.stopAutoupdate();},t.closeSidebar=function(){n.dismiss('cancel');};}]).controller('ModalShopitemDetailsController',['$scope','$stateParams','$uibModalInstance','item','Shopitems',function(t,e,i,o,n){t.item=o,t.complete=function(e){e.completed=!e.completed,n.update({id:e._id},{completed:e.completed},function(i){for(let o=0;o<t.item.details.length;o++)t.item.details[o]._id==i._id&&(t.item.details[o].completed=e.completed);},function(t){});},t.remove=function(e){e.completed=!e.completed,n.remove({id:e._id},null,function(e){for(let i=0;i<t.item.details.length;i++)t.item.details[i]._id==e._id&&t.item.details.splice(i,1);},function(t){});},t.close=function(){i.close();};}]).controller('ModalShopitemAddController',['$scope','$stateParams','$uibModalInstance','TAIngredients','units','ShopitemService',function(t,e,o,n,a,s){t.submitted=!1,t.units=a,t.newunit=e.unit?e.unit._id:void 0,t.newingredient=e.ingredient?e.ingredient:void 0,t.GetIngredients=function(t){return n.search({search:t,language:'de'}).$promise.then(function(t){return t;});},t.ok=function(e){if(!e)return void(t.submitted=!0);for(i=0;i<t.units.length;i++)t.units[i]._id===t.newunit&&(t.newunitobject=t.units[i]);const n={amount:t.newamount,unit:t.newunitobject,ingredient:t.newingredient};s.addShopitem(n),o.close();},t.cancel=function(){o.dismiss('cancel');};}]).controller('ActionSidebarShopitemsController',['$scope','$aside','units',function(t,e,i){t.shopitemsActions=function(){e.open({template:'<div ng-click="closeSidebar()" ng-include="\'partials/shopitems.links.tpl.html\'"></div>',controller:'ShopitemsActionSidebarController',placement:'right',size:'sm',resolve:{units:function(){return i;}}});};}]).config(['$stateProvider','modalStateProvider','$urlRouterProvider',function(t,e,i){t.state('user.shopitems',{'abstract':!0,url:'/shopitems',views:{main:{templateUrl:'partials/shopitems.layout.tpl.html'}},resolve:{shopitems:['ShopitemService',function(t){return t.data.autoupdate=!0,t.retrieveShopitems().then(function(t){return t;});}],frequentshopitems:['Frequentshopitems',function(t){return t.query().$promise;}],units:['Units',function(t){return t.query().$promise;}]},data:{title:'Shopping'}}).state('user.shopitems.view',{url:'',views:{main:{templateUrl:'partials/shopitems.tpl.html',controller:'ShopitemsController'},sidelinks:{templateUrl:'partials/shopitems.links.tpl.html',controller:'ShopitemsActionController'},'actionnavigation-xs@':{template:'<button type="button" class="navbar-toggle visible-xs actionbutton" ng-click="shopitemsActions()"><i class="glyphicon glyphicon-option-horizontal"></i></button>',controller:'ActionSidebarShopitemsController'},'actionnavigation-sm@':{template:'<a ng-click="shopitemsActions()" class="navbar-sm-more"><span class="glyphicon glyphicon-plus padding-right-10"></span>More</a>',controller:'ActionSidebarShopitemsController'}}}),e.state('user.shopitems.view.add',{url:'/add',templateUrl:'partials/shopitems.modal.add.tpl.html',controller:'ModalShopitemAddController',params:{ingredient:void 0,unit:void 0},resolve:{units:['Units',function(t){return t.query().$promise;}]}});}]);