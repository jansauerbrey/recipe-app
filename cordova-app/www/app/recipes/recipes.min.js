angular.module("app.recipes",["ui.router","modalstate","app.alert"]).factory("Recipes",["$resource","BASE_URI",function(e,i){return e(i+"api/recipes/:id",null,{update:{method:"PUT"}})}]).factory("TARecipes",["$resource","BASE_URI",function(e,i){return e(i+"api/typeahead/recipes/",null,{search:{method:"GET",isArray:!0}})}]).factory("TagsSelected",["$resource","BASE_URI",function(e,i){return e(i+"api/tags/selected/:id",null,{update:{method:"PUT"}})}]).factory("TATags",["$resource","BASE_URI",function(e,i){return e(i+"api/typeahead/tags/",null,{search:{method:"GET",isArray:!0}})}]).factory("Favorites",["$resource","BASE_URI",function(e,i){return e(i+"api/user/favorites/:id",null,{update:{method:"PUT"}})}]).factory("RecipeService",["$rootScope","$stateParams","$uibModal","AlertService","Recipes","$state","Favorites","UserService","Tags",function(e,t,r,s,a,c,n,l,o){var d={recipe:{},recipeOrig:{},factorAvailable:!1,factor:0,userExists:!1,allowEdit:!1,submitted:!1,validForm:!1},p=function(e,i){d.recipe=e,d.recipeOrig=angular.copy(d.recipe),d.factorAvailable=i>0,d.factor=d.factorAvailable?i:d.recipe["yield"];var t=l.getCurrentLoginUser();d.recipe.author&&t&&t._id==d.recipe.author._id||t&&t.is_admin===!0?(d.userExists=!0,d.allowEdit=!0):t&&(d.userExists=!0)},u=function(){if(!d.validForm)return s.add("danger","Please complete all required fields before saving."),d.submitted=!0,void e.$broadcast("submittedValueChanged");if(d.recipe&&!(d.recipe.length<1)){for(d.recipe.ingredients=d.recipe.ingredients.filter(function(e){return""!=e}),i=0;i<d.recipe.tags.length;i++)if(!d.recipe.tags[i]._id){var t=new o(d.recipe.tags[i]);t.$save(),d.recipe.tags[i]=t._id}for(i=0;i<d.recipe.ingredients.length;i++)d.recipe.ingredients[i].ingredient&&d.recipe.ingredients[i].ingredient._id||d.recipe.ingredients.splice(i,1);delete d.recipe._id,d.recipe.$save(function(e){c.go("user.recipes.details.view",{id:e._id})})}},v=function(){if(!d.validForm)return s.add("danger","Please complete all required fields before saving."),d.submitted=!0,void e.$broadcast("submittedValueChanged");for(i=0;i<d.recipe.tags.length;i++)if(!d.recipe.tags[i]._id){var t=new o(d.recipe.tags[i]);t.$save(),d.recipe.tags[i]=t._id}for(d.recipe.ingredients=d.recipe.ingredients.filter(function(e){return""!=e}),i=0;i<d.recipe.ingredients.length;i++)d.recipe.ingredients[i].ingredient&&d.recipe.ingredients[i].ingredient._id||d.recipe.ingredients.splice(i,1);a.update({id:d.recipe._id},d.recipe,function(i){p(i),c.go(e.previousState.name,e.previousStateParams)})},h=function(){a.remove({id:d.recipe._id},function(){"user.recipes.details.edit"===e.previousState.name?c.go("user.recipes.dishtypes"):c.go(e.previousState.name,e.previousStateParams)})},f=function(){d.recipe=angular.copy(d.recipeOrig),c.go(e.previousState.name,e.previousStateParams)},m=function(){var e=d;n.update({id:d.recipe._id},{method:"add"},function(i){l.updateFavoriteRecipes(i.favoriteRecipes),e.recipe.fav_recipe=!0})},g=function(){var e=d;n.update({id:d.recipe._id},{method:"delete"},function(i){l.updateFavoriteRecipes(i.favoriteRecipes),e.recipe.fav_recipe=!1})};return{data:d,setRecipe:p,setFavorite:m,unsetFavorite:g,create:u,update:v,remove:h,cancel:f}}]).factory("RecipeListService",["$rootScope","$stateParams","$uibModal","AlertService","Recipes","$state","Favorites","UserService","Tags",function(e,i,t,r,s,a,c,n,l){var o={recipes:[]},d=function(e,i){var t;for(t=0;t<e.length;t++)if(angular.equals(e[t],i))return t;return!1},p=function(e){o.recipes=e},u=function(){var e=o,t=new Date;t=i.new_recipe?t.setDate(t.getDate()-14):new Date(2015,0,0);var r={author:i.author,updated_at:t,dishType:i.dishType,_id:i.fav_recipe};s.query(r,function(i){e.recipes=i})},v=function(e){var i=o,t=d(o.recipes,e);c.update({id:e._id},{method:"add"},function(e){n.updateFavoriteRecipes(e.favoriteRecipes),i.recipes[t].fav_recipe=!0})},h=function(e){var i=o,t=d(o.recipes,e);c.update({id:e._id},{method:"delete"},function(e){n.updateFavoriteRecipes(e.favoriteRecipes),i.recipes[t].fav_recipe=!1})};return{getObject:function(){return o},setRecipes:p,queryRecipes:u,setFavorite:v,unsetFavorite:h}}]).controller("RecipeDishTypeController",["$scope","UserService","recipeCount",function(e,i,t){e.user=i.getCurrentLoginUser(),e.recipeCount=t.data}]).controller("RecipeListController",["$scope","$stateParams","$uibModal","RecipeListService","tags","user","Favorites","UserService",function(e,t,r,s,a,c,n,l){e.user=c,e.data=s.getObject(),e.tags=a,e.search={},e.tagfilter={},e.hideAdvSearch=!0,e.disableAndClearAuthor=function(){void 0!==e.search.author._id&&(e.search.author.fullname=void 0)},e.filterByTags=function(t){var r=!0;return angular.forEach(e.tagfilter,function(e,s){if(e===!0){var a=!1;for(i=0;i<t.tags.length;i++)if(s===t.tags[i].text){a=!0;break}r=r&&a}}),r},e.switchFavorite=function(e){e.fav_recipe?s.unsetFavorite(e):s.setFavorite(e)},e.share=function(e){r.open({animation:!0,templateUrl:"partials/recipes.share.tpl.html",controller:"ModalShareControllerRecipes",size:"xs",resolve:{recipe:function(){return e}}})}}]).controller("RecipeDetailCtrl",["$rootScope","$scope","$stateParams","$uibModal","Tags","units","dishtypes","TAIngredients","TATags","isCordova","RecipeService","navigationTitle",function(e,i,t,r,s,a,c,n,l,o,d,p){i.isCordova=o,d.data.submitted=!1,i.submitted=d.data.submitted,i.recipe=d.data.recipe,i.factorAvailable=d.data.factorAvailable,i.factor=d.data.factor,i.allowEdit=d.data.allowEdit,i.userExists=d.data.userExists;var u=p.getObject();u.title=i.recipe.name,i.favorite=function(){d.setFavorite()},i.unfavorite=function(){d.unsetFavorite()},i.save=function(){d.create()},i.update=function(){d.update()},i.remove=function(){d.remove()},i.cancel=function(){d.cancel()},i.$on("submittedValueChanged",function(){i.submitted=d.data.submitted}),i.clearImage=function(){i.recipe.imagePath="no_image.png"},i.share=function(){r.open({animation:!0,templateUrl:"partials/recipes.share.tpl.html",controller:"ModalShareControllerRecipes",size:"xs",resolve:{recipe:function(){return i.recipe}}})},i.units=a,i.dishtypes=c,i.onTypeaheadSelect=function(e,t,r){i.recipe.ingredients.filter(function(e){return""==e.ingredient}).length||i.recipe.ingredients.push({qty:"",unit:"",ingredient:""})},i.GetIngredients=function(e){return n.search({search:e,language:i.recipe.language}).$promise.then(function(e){return e})},i.addTag=function(e){if(!e._id){var t=new s(e);t.$save(function(e){var t=i.recipe.tags.length;i.recipe.tags[t-1]=e})}},i.loadTags=function(e){return l.search({search:e}).$promise.then(function(e){return e})},i.$watch("recipeForm.$valid",function(e){d.data.validForm=e})}]).controller("ModalShareControllerRecipes",["$scope","$modalInstance","$filter","recipe",function(e,t,r,s){e.recipe=s;var a=[];for(i=0;i<s.tags.length;i++)a.push(s.tags[i].text);e.hashtags=a.join(", "),e.cancel=function(){t.dismiss("cancel")}}]).controller("RecipeDetailActionsCtrl",["$rootScope","$scope","$uibModal","RecipeService",function(e,i,t,r){i.submitted=r.data.submitted,i.recipe=r.data.recipe,i.allowEdit=r.data.allowEdit,i.userExists=r.data.userExists,i.favorite=function(){r.setFavorite()},i.unfavorite=function(){r.unsetFavorite()},i.save=function(){r.create()},i.update=function(){r.update()},i.remove=function(){r.remove()},i.cancel=function(){r.cancel()},i.share=function(){t.open({animation:!0,templateUrl:"partials/recipes.share.tpl.html",controller:"ModalShareControllerRecipes",size:"xs",resolve:{recipe:function(){return i.recipe}}})}}]).controller("RecipeDetailActionSidebarController",["$rootScope","$scope","$uibModal","RecipeService","$modalInstance","isCordova","AlertService",function(e,i,t,r,s,a,c){i.isCordova=a,i.submitted=r.data.submitted,i.recipe=r.data.recipe,i.allowEdit=r.data.allowEdit,i.userExists=r.data.userExists,i.printingAvailable=cordova.plugins.printer.isAvailable(function(e){return e}),i.favorite=function(){r.setFavorite()},i.unfavorite=function(){r.unsetFavorite()},i.save=function(){r.data.submitted=!0,r.create()},i.update=function(){r.data.submitted=!0,r.update()},i.remove=function(){r.remove()},i.cancel=function(){r.cancel()},i.share=function(){t.open({animation:!0,templateUrl:"partials/recipes.share.tpl.html",controller:"ModalShareControllerRecipes",size:"xs",resolve:{recipe:function(){return i.recipe}}})};var n={message:"I recommend "+i.recipe.name,subject:i.recipe.name,url:"https://www.rezept-planer.de/#/sharedrecipe/"+i.recipe._id},l=function(e){e.completed&&c.add("success","Recipe shared with "+e.app)},o=function(e){c.add("danger","Error while sharing: "+e)};i.shareInApp=function(){window.plugins.socialsharing.shareWithOptions(n,l,o)},i.printInApp=function(){var e=document.getElementById("section-to-print");cordova.plugins.printer.print(e,"Recipe.html",function(){alert("printing finished or canceled")})},i.closeSidebar=function(){s.dismiss("cancel")}}]).controller("ActionSidebarRecipeController",["$scope","$aside",function(e,i){e.recipeDetailsView=function(){i.open({template:'<div ng-click="closeSidebar()" ng-include="\'partials/recipes.view.links.tpl.html\'"></div>',controller:"RecipeDetailActionSidebarController",placement:"right",size:"sm"})},e.recipeDetailsEdit=function(){i.open({template:'<div ng-click="closeSidebar()" ng-include="\'partials/recipes.edit.links.tpl.html\'"></div>',controller:"RecipeDetailActionSidebarController",placement:"right",size:"sm"})},e.recipeDetailsAdd=function(){i.open({template:'<div ng-click="closeSidebar()" ng-include="\'partials/recipes.add.links.tpl.html\'"></div>',controller:"RecipeDetailActionSidebarController",placement:"right",size:"sm"})}}]).config(["$stateProvider","modalStateProvider","$urlRouterProvider",function(e,i,t){function r(e,i,t){return{url:i,params:t,views:{"main@user":{templateUrl:"partials/recipes.list.tpl.html",controller:"RecipeListController"},"actionnavigation-xs@":{template:'<button type="button" class="navbar-toggle actionbutton" ui-sref="user.recipes.details.add"><i class="glyphicon glyphicon-plus"></i></button>',controller:"ActionSidebarRecipeController"}},resolve:{recipes:["Recipes","$stateParams","RecipeListService",function(e,i,t){var r=new Date;r=i.new_recipe?r.setDate(r.getDate()-14):new Date(2015,0,0);var s={author:i.author,updated_at:r,dishType:i.dishType,_id:i.fav_recipe};return e.query(s,function(e){t.setRecipes(e)}).$promise}],user:["UserService",function(e){return e.getCurrentLoginUser()}],tags:["TagsSelected",function(e){return e.query().$promise}]},data:{title:e}}}function s(){return{"abstract":!0,url:"/details/:id",views:{"main@user":{templateUrl:"partials/recipes.details.layout.tpl.html"}},resolve:{recipe:["Recipes","$stateParams","RecipeService",function(e,i,t){var r=e.get({id:i.id},function(e){t.setRecipe(e)}).$promise;return r}],units:["Units",function(e){return e.query().$promise}],dishtypes:["DishTypes",function(e){return e.query().$promise}]}}}function a(){return{url:"",params:{factor:null},views:{main:{templateUrl:"partials/recipes.view.tpl.html",controller:"RecipeDetailCtrl"},sidelinks:{templateUrl:"partials/recipes.view.links.tpl.html",controller:"RecipeDetailActionsCtrl"},"actionnavigation-xs@":{template:'<button type="button" class="navbar-toggle actionbutton" ng-click="recipeDetailsView()"><i class="glyphicon glyphicon-option-horizontal"></i></button>',controller:"ActionSidebarRecipeController"},"actionnavigation-sm@":{template:'<a ng-click="recipeDetailsView()" class="navbar-sm-more"><span class="glyphicon glyphicon-plus padding-right-10"></span>More</a>',controller:"ActionSidebarRecipeController"}}}}function c(e){var i={url:"/edit",views:{}};return i.views["main"+e]={templateUrl:"partials/recipes.edit.form.tpl.html",controller:"RecipeDetailCtrl"},i.views["sidelinks"+e]={templateUrl:"partials/recipes.edit.links.tpl.html",controller:"RecipeDetailActionsCtrl"},i.views["actionnavigation-xs@"]={template:'<button type="button" class="navbar-toggle actionbutton" ng-click="update()"><i class="glyphicon glyphicon-floppy-disk"></i></button>',controller:"RecipeDetailActionsCtrl"},i.views["actionnavigation-sm@"]={template:'<a ng-click="update()" class="navbar-sm-more"><span class="glyphicon glyphicon-floppy-disk padding-right-10"></span>Save</a>',controller:"RecipeDetailActionsCtrl"},i}function n(){return{url:"/scheduleadd",templateUrl:"partials/recipes.scheduleadd.tpl.html",controller:"ModalScheduleAddController",params:{date:void 0,recipe:void 0},resolve:{randomRecipes:["RandomRecipe",function(e){var i=e.query({number:"3"},function(e){return e});return i}]}}}e.state("user.recipes",{url:"/recipes",views:{main:{templateUrl:"partials/recipes.dishtypes.tpl.html",controller:"RecipeDishTypeController"},"actionnavigation-xs@":{template:'<button type="button" class="navbar-toggle actionbutton" ui-sref="user.recipes.details.add"><i class="glyphicon glyphicon-plus"></i></button>',controller:"ActionSidebarRecipeController"}},resolve:{recipeCount:["$http","BASE_URI",function(e,i){return e.get(i+"api/recipes/count").success(function(e){return e})}]},data:{title:"Recipes"}}).state("user.recipes.breakfast",r("Breakfast","/breakfast",{dishType:"56294bad07ee48b60ec4405b",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.breakfast.details",s()).state("user.recipes.breakfast.details.view",a()).state("user.recipes.breakfast.details.view.edit",c("@user.recipes.breakfast.details")).state("user.recipes.appetizer",r("Appetizer","/appetizer",{dishType:"562934ae137c052908b75e23",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.appetizer.details",s()).state("user.recipes.appetizer.details.view",a()).state("user.recipes.appetizer.details.view.edit",c("@user.recipes.appetizer.details")).state("user.recipes.drinks",r("Drinks","/drinks",{dishType:"562940bd4bdc01930dca94d8",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.drinks.details",s()).state("user.recipes.drinks.details.view",a()).state("user.recipes.drinks.details.view.edit",c("@user.recipes.drinks.details")).state("user.recipes.salads",r("Salads","/salads",{dishType:"562940db4bdc01930dca94da",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.salads.details",s()).state("user.recipes.salads.details.view",a()).state("user.recipes.salads.details.view.edit",c("@user.recipes.salads.details")).state("user.recipes.maindishes",r("Main Dishes","/maindishes",{dishType:"56293446137c052908b75e22",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.maindishes.details",s()).state("user.recipes.maindishes.details.view",a()).state("user.recipes.maindishes.details.view.edit",c("@user.recipes.maindishes.details")).state("user.recipes.sidedishes",r("Side Dishes","/sidedishes",{dishType:"562940cc4bdc01930dca94d9",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.sidedishes.details",s()).state("user.recipes.sidedishes.details.view",a()).state("user.recipes.sidedishes.details.view.edit",c("@user.recipes.sidedishes.details")).state("user.recipes.desserts",r("Desserts","/desserts",{dishType:"562940ee4bdc01930dca94db",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.desserts.details",s()).state("user.recipes.desserts.details.view",a()).state("user.recipes.desserts.details.view.edit",c("@user.recipes.desserts.details")).state("user.recipes.breads",r("Breads","/breads",{dishType:"562aabc37a696f1229593c42",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.breads.details",s()).state("user.recipes.breads.details.view",a()).state("user.recipes.breads.details.view.edit",c("@user.recipes.breads.details")).state("user.recipes.snacks",r("Snacks","/snacks",{dishType:"5668a3b36faed8e960d4f213",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.snacks.details",s()).state("user.recipes.snacks.details.view",a()).state("user.recipes.snacks.details.view.edit",c("@user.recipes.snacks.details")).state("user.recipes.other",r("Other Recipes","/other",{dishType:"5629f52a2b9118f35b96c2ca",author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.other.details",s()).state("user.recipes.other.details.view",a()).state("user.recipes.other.details.view.edit",c("@user.recipes.other.details")).state("user.recipes.all",r("All Recipes","/all",{dishType:void 0,author:void 0,new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.all.details",s()).state("user.recipes.all.details.view",a()).state("user.recipes.all.details.view.edit",c("@user.recipes.all.details")).state("user.recipes.my",r("My Recipes","/my",{dishType:void 0,author:"self",new_recipe:void 0,fav_recipe:void 0})).state("user.recipes.my.details",s()).state("user.recipes.my.details.view",a()).state("user.recipes.my.details.view.edit",c("@user.recipes.my.details")).state("user.recipes.new",r("New Recipes","/new",{dishType:void 0,author:void 0,new_recipe:!0,fav_recipe:void 0})).state("user.recipes.new.details",s()).state("user.recipes.new.details.view",a()).state("user.recipes.new.details.view.edit",c("@user.recipes.new.details")).state("user.recipes.favorites",r("Favorite Recipes","/favorites",{dishType:void 0,author:void 0,new_recipe:void 0,fav_recipe:!0})).state("user.recipes.favorites.details",s()).state("user.recipes.favorites.details.view",a()).state("user.recipes.favorites.details.view.edit",c("@user.recipes.favorites.details")).state("user.recipes.details",{"abstract":!0,url:"/details/:id",params:{factor:null},views:{"main@user":{templateUrl:"partials/recipes.details.layout.tpl.html"}},resolve:{recipe:["Recipes","$stateParams","RecipeService",function(e,i,t){if(i.id){var r=e.get({id:i.id},function(e){e.ingredients.push({qty:"",unit:"",ingredient:""}),t.setRecipe(e,i.factor)}).$promise;return r}var r=new e;return r.ingredients=[],r.ingredients.push({qty:"",unit:"",ingredient:""}),r.imagePath="no_image.png",t.data.recipe=r,r}],units:["Units",function(e){return e.query().$promise}],dishtypes:["DishTypes",function(e){return e.query().$promise}]}}).state("user.recipes.details.view",a()).state("user.recipes.details.edit",c()).state("user.recipes.details.add",{url:"^/recipe/add",views:{main:{templateUrl:"partials/recipes.edit.form.tpl.html",controller:"RecipeDetailCtrl"},sidelinks:{templateUrl:"partials/recipes.add.links.tpl.html",controller:"RecipeDetailActionsCtrl"},"actionnavigation-xs@":{template:'<button type="button" class="navbar-toggle actionbutton" ng-click="save()"><i class="glyphicon glyphicon-floppy-disk"></i></button>',controller:"RecipeDetailActionsCtrl"},"actionnavigation-sm@":{template:'<a ng-click="save()" class="navbar-sm-more"><span class="glyphicon glyphicon-floppy-disk padding-right-10"></span>Save</a>',controller:"RecipeDetailActionsCtrl"}}}).state("anon.recipes",{"abstract":!0,url:"/sharedrecipe",template:"<ui-view />",data:{title:"Recipes"}}).state("anon.recipes.details",{"abstract":!0,url:"/:id",params:{factor:null},templateUrl:"partials/recipes.details.layout.tpl.html",resolve:{recipe:["Recipes","$stateParams","RecipeService",function(e,i,t){if(i.id){var r=e.get({id:i.id},function(e){e.ingredients.push({qty:"",unit:"",ingredient:""}),t.setRecipe(e,i.factor)}).$promise;return r}var r=new e;return r.ingredients=[],r.ingredients.push({qty:"",unit:"",ingredient:""}),r.imagePath="no_image.png",t.data.recipe=r,r}],units:function(){return{}},dishtypes:function(){return{}}}}).state("anon.recipes.details.view",{url:"",params:{factor:null},views:{main:{templateUrl:"partials/recipes.view.tpl.html",controller:"RecipeDetailCtrl"},sidelinks:{templateUrl:"partials/recipes.view.links.tpl.html",controller:"RecipeDetailActionsCtrl"},"actionnavigation-xs@":{template:'<button type="button" class="navbar-toggle actionbutton" ng-click="recipeDetailsView()"><i class="glyphicon glyphicon-option-horizontal"></i></button>',controller:"ActionSidebarRecipeController"},"actionnavigation-sm@":{template:'<a ng-click="recipeDetailsView()" class="navbar-sm-more"><span class="glyphicon glyphicon-plus padding-right-10"></span>More</a>',controller:"ActionSidebarRecipeController"}}}).state("anon.recipes.details.view.edit",c("@anon.recipes.details")),i.state("user.recipes.breakfast.details.view.scheduleadd",n()).state("user.recipes.appetizer.details.view.scheduleadd",n()).state("user.recipes.drinks.details.view.scheduleadd",n()).state("user.recipes.salads.details.view.scheduleadd",n()).state("user.recipes.maindisches.details.view.scheduleadd",n()).state("user.recipes.sidedisches.details.view.scheduleadd",n()).state("user.recipes.desserts.details.view.scheduleadd",n()).state("user.recipes.breads.details.view.scheduleadd",n()).state("user.recipes.snacks.details.view.scheduleadd",n()).state("user.recipes.other.details.view.scheduleadd",n()).state("user.recipes.all.details.view.scheduleadd",n()).state("user.recipes.my.details.view.scheduleadd",n()).state("user.recipes.new.details.view.scheduleadd",n()).state("user.recipes.favorites.details.view.scheduleadd",n()).state("anon.recipes.details.view.scheduleadd",n()).state("user.recipes.breakfast.scheduleadd",n()).state("user.recipes.appetizer.scheduleadd",n()).state("user.recipes.drinks.scheduleadd",n()).state("user.recipes.salads.scheduleadd",n()).state("user.recipes.maindisches.scheduleadd",n()).state("user.recipes.sidedisches.scheduleadd",n()).state("user.recipes.desserts.scheduleadd",n()).state("user.recipes.breads.scheduleadd",n()).state("user.recipes.snacks.scheduleadd",n()).state("user.recipes.other.scheduleadd",n()).state("user.recipes.all.scheduleadd",n()).state("user.recipes.my.scheduleadd",n()).state("user.recipes.new.scheduleadd",n()).state("user.recipes.favorites.scheduleadd",n())}]);