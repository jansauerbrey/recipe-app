angular.module("app.schedules",["ui.router","modalstate"]).factory("Schedules",["$resource","BASE_URI",function(e,t){return e(t+"api/schedules/:id",null,{update:{method:"PUT"}})}]).factory("RandomRecipe",["$resource","BASE_URI",function(e,t){return e(t+"api/randomitems/recipes/:number",null,{update:{method:"PUT"}})}]).factory("SchedulesService",["UserService","AlertService","Schedules","$q","$rootScope",function(e,t,a,c,s){var r={schedules:[],selectedDates:[],activeDate:!1},d=function(e){e||(e=new Date),e.setHours(0,0,0,0),r.activeDate=e},l=function(e,t){e||(r.activeDate||d(),e=r.activeDate),t||(t=7);var a=[];for(i=0;i<t;i++){var c=new Date(e.getTime());c.setDate(c.getDate()+i),c.setHours(0,0,0,0),a.push(c.getTime())}r.selectedDates=a,s.$broadcast("selectedDatesUpdated")},n=function(t){var a=new Date,c=a.getDay(),s=e.data.currentUser.settings.preferredWeekStartDay?e.data.currentUser.settings.preferredWeekStartDay:0;s>c?a.setDate(a.getDate()-a.getDay()+s-7+7*t):a.setDate(a.getDate()-a.getDay()+s+7*t),l(a,7),u()},o=function(){var e=c.defer(),t=Math.min.apply(null,r.selectedDates),s=Math.max.apply(null,r.selectedDates),d=new Date(t);d.setHours(0,0,0,0),d=d.getTime();var l=new Date(s);return l.setDate(l.getDate()+1),l.setHours(0,0,0,0),l=l.getTime(),a.query({startDate:d,endDate:l},function(t){var a=[];for(i=0;i<r.selectedDates.length;i++){var c=new Date(r.selectedDates[i]);c.setHours(0,0,0,0),a[i]={date:c,schedule:[]}}for(i=0;i<t.length;i++){var c=new Date(t[i].date);for(c.setHours(0,0,0,0),j=0;j<r.selectedDates.length;j++)angular.equals(a[j].date,c)&&a[j].schedule.push(t[i])}e.resolve(a)}),e.promise},u=function(){o().then(function(e){r.schedules=e,s.$broadcast("schedulesUpdated")})},p=function(e,c){a.remove({id:e._id},function(){var a=r.schedules[c].schedule.indexOf(e);r.schedules[c].schedule.splice(a,1),s.$broadcast("schedulesUpdated");var d="The recipe "+e.recipe.name+" was successfully removed from schedule";t.add("info",d)})};return d(),{data:r,setActiveDate:d,selectPeriod:l,selectWeek:n,update:u,retrieve:o,remove:p}}]).controller("SchedulesController",["$scope","$stateParams","$uibModal","Schedules","schedules","SchedulesService","RandomRecipe",function(e,t,a,c,s,r,d){e.selectedDates=r.data.selectedDates,e.$on("selectedDatesUpdated",function(){e.selectedDates=r.data.selectedDates}),e.schedulesArray=r.data.schedules,e.$on("schedulesUpdated",function(){e.schedulesArray=r.data.schedules}),e.activeDate=r.data.activeDate,r.setActiveDate(),e.selectSevenDays=function(e){r.selectPeriod(e,7)},e.selectSevenDays(e.activeDate),e.updateSchedules=function(){r.update()},e.selectWeek=function(e){r.selectWeek(e)},e.remove=function(e,t){r.remove(e,t)},e.scheduleEdit=function(e){a.open({animation:!0,templateUrl:"partials/schedules.edit.tpl.html",controller:"ModalScheduleEditController",size:"xs",resolve:{schedule:function(){return e}}})}}]).controller("ModalScheduleEditController",["$scope","$stateParams","$uibModalInstance","$filter","AlertService","SchedulesService","Schedules","schedule",function(e,t,a,c,s,r,d,l){e.recipe=l.recipe,e.date=l.date,e.factor=l.factor,e.remove=function(){d.remove({id:l._id},function(){var e="The recipe "+l.recipe.name+" was successfully removed from schedule";s.add("info",e),r.update(),a.close()})},e.ok=function(){l.date=e.date,l.factor=e.factor,d.update({id:l._id},l,function(t){var d="The recipe "+e.recipe.name+" was successfully scheduled for the "+c("date")(e.date,"dd.MM.yyyy")+" with "+e.factor+" persons.";s.add("success",d),r.update(),a.close()})},e.cancel=function(){a.dismiss("cancel")}}]).controller("ModalScheduleAddController",["$scope","$state","$stateParams","$uibModalInstance","$filter","AlertService","SchedulesService","Schedules","randomRecipes","TARecipes",function(e,t,a,c,s,r,d,l,i,n){e.date=a.date?a.date:new Date,e.newrecipe=a.recipe?a.recipe:void 0,e.factor=a.recipe&&a.recipe["yield"]?a.recipe["yield"]:void 0,e.randomRecipes=i,e.GetRecipes=function(e){return n.search({search:e}).$promise.then(function(e){return e})},e.TASelect=function(t){e.factor=t["yield"]},e.selectRecipe=function(t){e.factor||(e.factor=t["yield"]),e.newrecipe=t},e.ok=function(){if(e.newrecipe&&!(e.newrecipe.length<1)){(!e.factor||e.factor.length<1)&&(e.factor=e.recipe["yield"]);var a=new l({date:e.date.setHours(12),recipe:e.newrecipe,factor:e.factor});a.$save(function(a){var l="The recipe "+e.newrecipe.name+" was successfully scheduled for the "+s("date")(e.date,"dd.MM.yyyy")+" with "+e.factor+" persons.";r.add("success",l),t.includes("user.schedules")&&d.update(),c.close()})}},e.cancel=function(){c.dismiss("cancel")}}]).config(["$stateProvider","modalStateProvider","$urlRouterProvider",function(e,t,a){e.state("user.schedules",{url:"/schedules",views:{main:{templateUrl:"partials/schedules.tpl.html",controller:"SchedulesController"}},resolve:{schedules:["SchedulesService",function(e){return e.selectPeriod(),e.update()}]},data:{title:"Schedules"}}),t.state("user.schedules.add",{url:"/add",templateUrl:"partials/schedules.add.tpl.html",controller:"ModalScheduleAddController",params:{date:void 0,recipe:void 0},resolve:{randomRecipes:["RandomRecipe",function(e){var t=e.query({number:"3"},function(e){return e});return t}]}})}]);